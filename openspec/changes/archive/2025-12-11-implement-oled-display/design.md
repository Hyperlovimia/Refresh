# Design: OLED 显示驱动实装

## Context

项目使用 SSD1306 128x64 I2C OLED 显示屏，与 SHT35 温湿度传感器共享 I2C 总线（GPIO21/22）。系统已实现 I2C 互斥锁机制 (`get_i2c_mutex()`)。

**重要变更：** 天气 API 已迁移至远程服务器，ESP32 本地不再获取和显示天气数据。

**约束条件：**
- I2C 地址：0x3C
- 分辨率：128x64 像素
- 刷新频率：主页面 2 秒/次
- 必须与 SHT35 共享 I2C 总线，需使用互斥锁

## Goals / Non-Goals

**Goals:**
- 实现规范中定义的显示功能（移除天气相关）
- 使用成熟的 u8g2 图形库
- 保持与现有 I2C 架构的兼容性
- 利用移除天气行后的空间扩展趋势图

**Non-Goals:**
- 不实现触摸交互
- 不支持动态字体切换
- 不实现复杂动画效果
- 不显示天气/AQI 数据（已迁移至远程服务器）

## Decisions

### 1. 移除 WeatherData 参数

**决定：** 从 `oled_display_main_page()` 函数签名中移除 `WeatherData *weather` 参数

**理由（经 Codex 验证）：**
- 当前 `main/main.c:389` 调用已传 NULL
- 实现中从未解引用该指针，属于死代码
- 移除后编译器会标记任何遗留的调用点
- 若未来需要重新引入天气显示，UI 布局也需重新设计，届时可引入新的 `DisplayModel` 结构

### 2. 新 UI 布局（无天气行）

**决定：** 移除天气行，扩展趋势图区域

**新布局（128x64 像素）：**
```
┌────────────────────────────────┐
│ CO₂: 850ppm [良好]    [REMOTE] │  ← 第1行 (0-15px, 大字号16px)
│ 温度:24.5°C  湿度:58%          │  ← 第2行 (16-25px, 6x10字体)
│ ┌──────────────────────────┐   │
│ │     CO₂ 趋势图           │   │  ← 第3-6行 (26-55px, 扩展区域)
│ │  ----1000ppm基准线----   │   │     - 增加 1000ppm 基准线
│ │  ....1500ppm告警线....   │   │     - 增加 1500ppm 告警虚线
│ └──────────────────────────┘   │
│ 风扇:[●低速] 3min  WiFi:●●●    │  ← 第7-8行 (56-63px, 状态栏)
└────────────────────────────────┘
```

**布局变更说明：**
- 移除原第3行"室外: AQI xx 优"
- 趋势图从 30px 扩展到 30px（保持不变，但位置上移）
- 本地模式警告改为右上角小徽章 `[LOCAL]`
- 状态栏合并为单行，节省空间

### 3. 图形库选择：u8g2

**决定：** 使用 olikraus/u8g2 库

**理由：**
- ESP-IDF 生态中最成熟的单色 OLED 驱动库
- 支持 SSD1306 及多种显示控制器
- 内置丰富字体
- 全缓冲模式适合复杂 UI 绘制

### 4. HAL 适配方案

**决定：** 自行实现 ESP-IDF I2C HAL 回调

**理由：**
- 需要集成现有的 I2C 互斥锁机制
- 避免引入额外依赖
- 代码量小（约 100 行）

**实现要点：**
```c
// HAL 回调函数签名
uint8_t u8g2_esp32_i2c_byte_cb(u8x8_t *u8x8, uint8_t msg, uint8_t arg_int, void *arg_ptr);
uint8_t u8g2_esp32_gpio_and_delay_cb(u8x8_t *u8x8, uint8_t msg, uint8_t arg_int, void *arg_ptr);
```

### 5. 字体选择

**决定：** 使用以下字体组合

| 用途 | 字体 | 说明 |
|------|------|------|
| CO2 数值（大） | `u8g2_font_logisoso16_tn` | 16px 数字字体 |
| 普通文本 | `u8g2_font_6x10_tf` | 6x10 像素，规范指定 |
| 模式徽章 | `u8g2_font_5x7_tf` | 5x7 小字体 |

### 6. 历史数据存储

**决定：** 使用静态环形缓冲区，容量可扩展至 60 点

```c
#define HISTORY_BUFFER_SIZE 60  // 10小时，每10分钟一个点（从48扩展）

typedef struct {
    float co2_values[HISTORY_BUFFER_SIZE];
    uint8_t head;       // 写入位置
    uint8_t count;      // 有效数据数量
} HistoryBuffer;
```

**理由：**
- 固定大小，无动态内存分配
- O(1) 插入和遍历
- 内存占用：60 * 4 = 240 字节（仅增加 48 字节）

### 7. 告警闪烁机制

**决定：** 使用 FreeRTOS 软件定时器

**实现方案：**
- 创建 1Hz 定时器控制闪烁状态
- 告警显示时启动定时器
- 3 秒后自动停止并切换回主页面

## Risks / Trade-offs

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| u8g2 内存占用较大 | 可能影响其他任务 | 使用 F 后缀（全缓冲）模式，约 1KB 缓冲区 |
| I2C 总线竞争 | 显示刷新延迟 | 已有互斥锁机制，设置合理超时 |
| API 破坏性变更 | 需更新调用点 | 编译器会标记所有遗留调用 |

## Migration Plan

1. 更新 `oled_display.h` 函数签名
2. 更新 `oled_display.c` 实现
3. 更新 `main.c` 调用点（移除 NULL 参数）
4. 更新规范文档移除天气相关场景

## Open Questions

1. **趋势图数据点数量：** 48 点（8小时）还是 60 点（10小时）？
   - 建议：60 点，内存增加可忽略
2. **本地模式徽章位置：** 右上角还是趋势图内？
   - 建议：右上角，避免遮挡图表
