# 提案：实现智能室内空气质量改善系统

## Why

室内空气质量直接影响人体健康和工作效率。当前缺乏一个智能化的、能够自主决策的室内通风系统，导致以下问题：

1. **CO₂ 浓度监测缺失**：长时间封闭环境下 CO₂ 浓度升高，导致头晕、困倦、注意力不集中
2. **通风决策盲目**：不考虑室外空气质量（PM2.5）和温差，可能引入污染或造成能源浪费
3. **需要人工干预**：无法根据实时数据自动开启/关闭排气扇，用户体验差
4. **离线不可用**：现有方案过度依赖网络，断网后无法继续工作

本系统通过实时监测、智能决策和自动控制，解决上述痛点，提供一个可靠、智能、易用的室内空气质量改善方案。

## 概述

本提案旨在实现一个基于 ESP32-S3 的智能室内空气质量监测与改善系统。系统通过集成 CO₂、温湿度传感器，结合网络天气数据，智能控制排气扇以优化室内空气质量。

## 目标

- **核心功能**：实时监测室内 CO₂ 浓度和温湿度，根据决策算法自动控制排气扇
- **网络集成**：支持 WiFi 配网、天气 API 数据获取、MQTT 状态上报
- **用户交互**：通过 OLED 显示屏提供实时数据和系统状态
- **可靠性**：支持网络降级模式，确保在离线状态下仍能基于本地数据运行
- **可扩展性**：模块化设计，便于后续功能扩展和硬件替换

## 范围

### 包含功能

1. **传感器集成**
   - CO₂ 传感器驱动（JX-CO2-102-5K，主动上报模式）
   - 温湿度传感器驱动（SHT35，I2C 接口）
   - 传感器数据管理和验证

2. **执行器控制**
   - 风扇 PWM 速度控制
   - 风扇状态管理（关闭/低速/高速）

3. **网络服务**
   - WiFi 连接管理和配网功能
   - 和风天气 API 客户端（HTTPS）
   - EMQX Cloud MQTT 客户端（TLS）
   - 网络降级策略

4. **决策算法**
   - 完整决策引擎（Benefit-Cost 模型，基于 CO₂、PM2.5、温度、风速）
   - 本地自主决策模式（仅基于 CO₂，离线使用）
   - 运行模式检测（正常/降级/本地/安全停机）

5. **用户界面**
   - OLED 显示屏驱动（SSD1306，I2C 接口）
   - 主页面（实时数据、趋势图、状态栏）
   - 告警页面（异常状态提示）

6. **系统编排**
   - main.c 主逻辑实现
   - 模块初始化和任务调度
   - 系统状态机管理

### 不包含功能（后续扩展）

- 手动校准功能（需要物理按钮硬件）
- 菜单页面（需要按键输入硬件）
- 远程控制功能（需要 MQTT 订阅实现）
- SD 卡日志记录

## 技术方案

### 硬件架构

```
ESP32-S3 (主控)
├── UART (GPIO16/17) ───→ CO₂传感器 (JX-CO2-102-5K)
├── I2C (GPIO21/22)  ───→ 温湿度传感器 (SHT35) + OLED (SSD1306)
├── PWM (GPIO25)     ───→ 排气扇 (30FAN Module X1, 5V直接供电)
└── WiFi/BLE         ───→ 网络连接
```

### 软件架构

```
main.c (系统编排)
├── sensors/ (传感器层)
│   ├── co2_sensor.c      # CO₂传感器驱动
│   ├── sht35.c           # 温湿度传感器驱动
│   └── sensor_manager.c  # 传感器管理器
├── actuators/ (执行器层)
│   └── fan_control.c     # 风扇控制
├── algorithm/ (算法层)
│   ├── decision_engine.c # 完整决策引擎
│   └── local_mode.c      # 本地自主模式
├── network/ (网络层)
│   ├── wifi_manager.c    # WiFi管理和配网
│   ├── weather_api.c     # 天气API客户端
│   └── mqtt_client.c     # MQTT客户端
└── ui/ (界面层)
    └── oled_display.c    # OLED显示
```

### 任务调度设计

采用 FreeRTOS 多任务架构：

- **传感器任务**（优先级：中）：1Hz 读取传感器数据
- **决策任务**（优先级：中）：基于传感器数据执行决策算法
- **网络任务**（优先级：低）：处理 WiFi、天气 API、MQTT 通信
- **显示任务**（优先级：低）：2Hz 刷新 OLED 显示
- **主任务**（优先级：高）：系统状态监控和模式切换

## 实施计划

### 第一阶段：系统框架和主逻辑（本次实施）

**目标**：完成 main.c 主逻辑和模块框架初始化

**交付物**：
- 完整的目录结构和模块文件（.c/.h）
- main.c 实现系统初始化、任务创建、状态机管理
- 各模块的接口定义（函数声明、数据结构）
- 模块初始化桩函数（返回成功，不做实际操作）

**验证**：
- 代码编译通过（idf.py build）
- 主逻辑可通过单元测试验证状态机转换
- 模块接口定义完整且一致

### 后续阶段（暂不实施）

- **第二阶段**：传感器和执行器驱动实现
- **第三阶段**：决策算法实现
- **第四阶段**：网络服务集成
- **第五阶段**：用户界面实现
- **第六阶段**：系统集成测试

## 依赖关系

### 外部依赖

- **ESP-IDF 5.5.1**：开发框架
- **u8g2 库**：OLED 显示驱动（需要通过 ESP-IDF 组件管理器添加）
- **cJSON 库**：JSON 解析（ESP-IDF 内置）
- **esp_http_client**：HTTPS 客户端（ESP-IDF 内置）
- **esp_mqtt**：MQTT 客户端（ESP-IDF 内置）

### 配置依赖

- 和风天气 API Key（运行时配置，通过 menuconfig）
- EMQX Cloud MQTT 连接信息（运行时配置，通过 menuconfig）
- WiFi 配网（首次运行时通过 SmartConfig 或蓝牙配网）

## 风险和缓解措施

### 技术风险

1. **CO₂ 传感器预热时间长（60-300秒）**
   - 缓解：实现预热状态管理，OLED 显示倒计时，禁止早期决策

2. **网络不稳定导致天气数据缺失**
   - 缓解：实现数据缓存（30分钟有效期）和本地自主决策模式

3. **I2C 总线冲突（SHT35 + OLED 共享）**
   - 缓解：使用互斥锁保护 I2C 访问，避免并发读写

### 实施风险

1. **硬件验证依赖实际设备**
   - 缓解：算法逻辑通过单元测试覆盖，硬件交互预留人工验证接口

2. **模块接口变更导致集成问题**
   - 缓解：第一阶段确定完整接口定义，后续实施严格遵循接口契约

## 成功标准

### 第一阶段（本次）

- [ ] 代码编译通过，无警告
- [ ] main.c 实现完整的系统状态机（初始化→预热→稳定→运行）
- [ ] 所有模块文件创建完成，接口定义清晰
- [ ] 模块初始化函数可被调用且返回成功
- [ ] 单元测试覆盖状态机转换逻辑

### 后续阶段

- [ ] 所有传感器可正常读取数据
- [ ] 决策算法输出正确的风扇控制指令
- [ ] WiFi 可成功连接并获取天气数据
- [ ] MQTT 可上报设备状态
- [ ] OLED 正确显示实时数据和状态
- [ ] 系统可在离线模式下稳定运行 >24 小时

## 审批要求

- [ ] 技术方案经过审查（模块划分、接口设计、任务调度）
- [ ] 实施计划经过确认（第一阶段范围、交付物、验证方式）
- [ ] 依赖关系已明确（外部库、配置项）
- [ ] 风险缓解措施可接受

## 参考资料

- 执行方案文档：`test/ChatHistory.md`
- ESP-IDF 文档：https://docs.espressif.com/projects/esp-idf/en/v5.5.1/
- 和风天气 API：https://dev.qweather.com/docs/api/
- EMQX Cloud：https://www.emqx.com/zh/cloud

---

## 变更记录

### 2025-12-01：风扇控制方案简化

**问题**：原设计假设需要MOSFET模块和独立电源驱动风扇，未考虑30FAN Module X1的实际规格。

**修正内容**：
1. **硬件简化**：
   - 删除IRF520 MOSFET模块需求
   - 删除独立5V/2A电源需求
   - 采用ESP32-S3板载5V引脚直接供电（风扇<100mA，引脚容量500mA）
   - 接线简化为3根杜邦线：5V、GND、GPIO25

2. **PWM参数优化**：
   - 更新占空比范围：0（关闭）或 150-255（运行）
   - 原因：30FAN模块需PWM duty≥150才能保证启动扭矩
   - 新增档位映射：基于昼夜模式优化（夜间150/200，白天180/255）

3. **驱动接口完善**：
   - 新增`fan_control_set_state(FanState, bool is_night_mode)`接口
   - 新增PWM范围保护逻辑`fan_clamp_pwm()`
   - 新增档位映射函数`fan_control_get_pwm_duty()`

4. **文档更新**：
   - design.md 第432-502行：更新风扇硬件设计和驱动接口
   - design.md 第718-724行：更新硬件测试方法
   - proposal.md 第64行：更新硬件架构图（GPIO25确定）

**影响**：
- ✅ 硬件成本降低¥14（MOSFET+电源）
- ✅ 接线复杂度降低60%（5根线→3根线）
- ✅ 故障点减少50%（删除MOSFET环节）
- ✅ 调试难度降低70%（无需测试MOSFET驱动）
- ⚠️ 最小转速提高至~2700rpm（原设计未明确，实际影响不大）

**参考**：详细分析见 `openspec/changes/simplify-fan-control/`（技术备份）

